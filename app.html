<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="mfhsieh at github (https://github.com/mfhsieh/business-card-express/)">
    <meta name="copyright"
        content="mfhsieh at github (https://github.com/mfhsieh/business-card-express/), CC BY-NC-SA 4.0">
    <title>名片快手</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M17 18a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2'/><rect width='18' height='18' x='3' y='4' rx='2'/><circle cx='12' cy='10' r='2'/><line x1='8' x2='8' y1='2' y2='4'/><line x1='16' x2='16' y1='2' y2='4'/></svg>"
        type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* 自訂捲軸 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900 p-2 md:p-6 lg:p-8">

    <div class="max-w-[1400px] mx-auto">
        <header class="mb-8 text-center">
            <h1
                class="text-3xl md:text-4xl font-black text-slate-900 tracking-tight flex items-center justify-center gap-3">
                <i data-lucide="contact" class="w-10 h-10 text-indigo-600"></i>
                名片快手
            </h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">

            <!-- 左側：操作與預覽區 -->
            <div class="lg:col-span-5 space-y-6 lg:sticky lg:top-8">
                <!-- 上傳區 -->
                <div
                    class="bg-white p-6 rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-100 p-4 md:p-8">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="upload-cloud" class="text-indigo-600"></i> 上傳與辨識
                    </h2>

                    <div id="dropZone"
                        class="group border-2 border-dashed rounded-2xl aspect-[1.6/1] flex flex-col items-center justify-center transition-all overflow-hidden border-slate-200 hover:border-indigo-400 cursor-pointer hover:bg-slate-50 relative">
                        <div id="uploadPlaceholder" class="text-center p-6 transition-transform group-hover:scale-105">
                            <i data-lucide="image-plus"
                                class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 shadow-sm border border-slate-100"></i>
                            <p class="font-bold text-slate-600">點擊或拖放名片照片</p>
                            <p class="text-xs text-slate-400 mt-2">支援 JPG, PNG 格式</p>
                        </div>
                        <img id="previewImage" class="hidden w-full h-full object-contain p-2 bg-slate-100" />
                        <input type="file" id="fileInput" class="hidden" accept="image/*" />
                    </div>

                    <button id="identifyBtn" disabled
                        class="w-full mt-6 py-4 rounded-2xl font-black text-lg flex items-center justify-center gap-3 transition-all bg-slate-100 text-slate-400 shadow-indigo-600/10">
                        <i data-lucide="sparkles" id="btnIcon" class="w-5 h-5"></i>
                        <span id="btnText">啟動 AI 智慧辨識</span>
                    </button>

                    <div id="errorMessage"
                        class="hidden mt-4 p-4 bg-red-50 text-red-700 rounded-xl flex items-start gap-3 text-sm font-bold border border-red-100">
                        <i data-lucide="alert-triangle" class="w-5 h-5 shrink-0"></i>
                        <span id="errorText"></span>
                    </div>
                </div>

                <!-- AI 智慧摘要區塊 -->
                <div id="summaryContainer"
                    class="hidden bg-white p-6 rounded-[2rem] shadow-xl shadow-slate-200/50 border border-indigo-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold flex items-center gap-2 text-indigo-700">
                            <i data-lucide="sparkles" class="w-5 h-5"></i> AI 洞察 (AI Insights)
                        </h2>
                        <button id="generateEmailBtn"
                            class="text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded-lg flex items-center gap-1 transition-colors shadow-sm active:scale-95">
                            <i data-lucide="mail" class="w-4 h-4"></i> 後續追蹤
                        </button>
                    </div>
                    <div class="space-y-4">
                        <!-- 公司摘要 -->
                        <div id="companySummaryBlock" class="hidden">
                            <div class="flex justify-between items-center mb-2 cursor-pointer group"
                                onclick="UXManager.toggleSection('companySummaryContent', 'companySummaryIcon')">
                                <h3
                                    class="text-xs font-black text-indigo-600 uppercase tracking-widest flex items-center gap-1 group-hover:text-indigo-800 transition-colors">
                                    <i data-lucide="building" class="w-4 h-4"></i> 公司摘要 (Company Summary)
                                </h3>
                                <i data-lucide="chevron-up" id="companySummaryIcon"
                                    class="w-4 h-4 text-indigo-400 transition-transform duration-300"></i>
                            </div>
                            <div id="companySummaryContent"
                                class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-50 transition-all">
                                <textarea id="field-companySummary" rows="1"
                                    class="w-full bg-transparent outline-none text-sm text-slate-700 leading-relaxed font-medium resize-none overflow-hidden placeholder:text-indigo-300"
                                    placeholder="AI 將上網搜尋公司背景並摘要..."></textarea>
                            </div>
                        </div>
                        <!-- 個人摘要 -->
                        <div id="personalSummaryBlock" class="hidden">
                            <div class="flex justify-between items-center mb-2 cursor-pointer group"
                                onclick="UXManager.toggleSection('personalSummaryContent', 'personalSummaryIcon')">
                                <h3
                                    class="text-xs font-black text-purple-600 uppercase tracking-widest flex items-center gap-1 group-hover:text-purple-800 transition-colors">
                                    <i data-lucide="user-check" class="w-4 h-4"></i> 個人摘要 (Personal Summary)
                                </h3>
                                <i data-lucide="chevron-up" id="personalSummaryIcon"
                                    class="w-4 h-4 text-purple-400 transition-transform duration-300"></i>
                            </div>
                            <div id="personalSummaryContent"
                                class="bg-purple-50/50 p-4 rounded-xl border border-purple-50 transition-all">
                                <textarea id="field-personalSummary" rows="1"
                                    class="w-full bg-transparent outline-none text-sm text-slate-700 leading-relaxed font-medium resize-none overflow-hidden placeholder:text-purple-300"
                                    placeholder="AI 將上網搜尋個人背景並摘要..."></textarea>
                            </div>
                        </div>

                        <!-- 參考來源區塊 -->
                        <div id="sourcesBlock" class="hidden pt-2 border-t border-slate-100">
                            <div class="flex justify-between items-center mb-2 cursor-pointer group"
                                onclick="UXManager.toggleSection('sourcesListWrapper', 'sourcesIcon')">
                                <h3
                                    class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1 group-hover:text-slate-600 transition-colors">
                                    <i data-lucide="link" class="w-3 h-3"></i> 參考來源 (Sources)
                                </h3>
                                <i data-lucide="chevron-up" id="sourcesIcon"
                                    class="w-3 h-3 text-slate-300 transition-transform duration-300"></i>
                            </div>
                            <div id="sourcesListWrapper" class="transition-all">
                                <div id="sourcesList" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>

                        <!-- AI 郵件草稿 -->
                        <div id="emailDraftContainer" class="hidden mt-4 pt-4 border-t border-indigo-100">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2 cursor-pointer flex-1 group"
                                    onclick="UXManager.toggleSection('emailDraftContent', 'emailDraftIcon')">
                                    <h3
                                        class="text-xs font-black text-indigo-600 uppercase tracking-widest flex items-center gap-1 group-hover:text-indigo-800 transition-colors">
                                        <i data-lucide="mail" class="w-4 h-4"></i> 後續追蹤 (Follow-up)
                                    </h3>
                                    <i data-lucide="chevron-up" id="emailDraftIcon"
                                        class="w-4 h-4 text-indigo-400 transition-transform duration-300"></i>
                                </div>
                                <button onclick="copyEmailDraft()"
                                    class="text-xs text-indigo-500 hover:text-indigo-700 flex items-center gap-1 bg-indigo-50 px-2 py-1 rounded transition-colors ml-2 shrink-0">
                                    <i data-lucide="copy" class="w-3 h-3"></i> 複製
                                </button>
                            </div>
                            <div id="emailDraftContent"
                                class="bg-white p-4 rounded-xl border border-indigo-100 relative shadow-inner transition-all">
                                <div id="emailLoading"
                                    class="hidden absolute inset-0 bg-white/90 flex flex-col items-center justify-center rounded-xl z-10 backdrop-blur-sm">
                                    <i data-lucide="loader-2" class="w-6 h-6 text-indigo-600 animate-spin mb-2"></i>
                                    <span class="text-sm font-bold text-indigo-600">AI 撰寫中...</span>
                                </div>
                                <textarea id="field-emailDraft" rows="1"
                                    class="w-full text-sm text-slate-700 outline-none resize-none overflow-hidden bg-transparent"
                                    placeholder="AI 將在此生成郵件草稿..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 產出區 -->
                <div class="bg-white p-6 rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-100">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="qr-code" class="text-indigo-600"></i> 聯絡人 QR Code
                    </h2>
                    <div
                        class="bg-gradient-to-br from-slate-50 to-indigo-50/30 p-6 rounded-3xl border border-slate-100 flex flex-col items-center">
                        <div class="bg-white p-4 rounded-2xl shadow-md mb-4 border border-slate-50 relative group">
                            <div id="qrPlaceholder"
                                class="w-48 h-48 flex items-center justify-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-200">
                                <i data-lucide="scan" class="w-16 h-16 text-slate-300"></i>
                            </div>
                            <!-- QR Code 圖片 -->
                            <img id="qrImage" class="hidden w-48 h-48" alt="vCard QR Code" />
                        </div>
                        <p id="qrStatus" class="text-sm font-black text-slate-400 uppercase tracking-widest">等待資料輸入...
                        </p>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button id="saveVcfBtn"
                            class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-indigo-700 active:scale-95 shadow-lg shadow-indigo-600/30 transition-all">
                            <i data-lucide="download"></i> 下載 vCard
                        </button>
                        <button id="copyVcfBtn"
                            class="flex-1 py-4 bg-white border-2 border-indigo-200 text-indigo-600 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-indigo-50 hover:border-indigo-300 active:scale-95 shadow-sm transition-all">
                            <i data-lucide="copy"></i> <span id="copyVcfText">複製內容</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右側：資料編輯區 -->
            <div class="lg:col-span-7 space-y-6">
                <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-100">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-2xl font-black flex items-center gap-2 text-slate-800">
                            <i data-lucide="file-edit" class="text-indigo-600 w-6 h-6"></i> 編輯名片資料
                        </h2>
                        <button onclick="clearForm()"
                            class="text-sm font-bold text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> 清空
                        </button>
                    </div>

                    <div id="fieldsContainer" class="space-y-8">
                        <!-- 姓名結構 -->
                        <div class="space-y-4">
                            <h3
                                class="text-sm font-black text-indigo-600 uppercase tracking-widest flex items-center gap-2 border-b border-slate-100 pb-2">
                                <i data-lucide="user" class="w-4 h-4"></i> 姓名 (Name)
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                                <div class="md:col-span-6">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">全名 (Full Name)</label>
                                    <input type="text" id="field-fn"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold text-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">姓氏 (Last Name)</label>
                                    <input type="text" id="field-lastName"
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">名字 (First Name)</label>
                                    <input type="text" id="field-firstName"
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">中間名 (Middle Name)</label>
                                    <input type="text" id="field-middleName"
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">稱謂 (Prefix)</label>
                                    <input type="text" id="field-prefix" placeholder="如：Dr., Mr., Mrs."
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">頭銜後綴 (Suffix)</label>
                                    <input type="text" id="field-suffix" placeholder="如：Ph.D., Jr., M.D."
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- 組織結構 -->
                        <div class="space-y-4">
                            <h3
                                class="text-sm font-black text-indigo-600 uppercase tracking-widest flex items-center gap-2 border-b border-slate-100 pb-2">
                                <i data-lucide="building-2" class="w-4 h-4"></i> 組織職稱 (ORG & Title)
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">組織 (ORG)</label>
                                    <input type="text" id="field-orgName"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">部門 (Unit)</label>
                                    <input type="text" id="field-orgUnit"
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">職稱 (Title)</label>
                                    <input type="text" id="field-title"
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- 動態聯絡方式 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-slate-100 pb-2">
                                    <h3
                                        class="text-sm font-black text-indigo-600 uppercase tracking-widest flex items-center gap-2">
                                        <i data-lucide="phone" class="w-4 h-4"></i> 電話 (Phone)
                                    </h3>
                                    <button onclick="addListItem('phones')" class="text-indigo-600 text-xs font-black">+
                                        新增</button>
                                </div>
                                <div id="list-phones" class="space-y-2"></div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-slate-100 pb-2">
                                    <h3
                                        class="text-sm font-black text-indigo-600 uppercase tracking-widest flex items-center gap-2">
                                        <i data-lucide="printer" class="w-4 h-4"></i> 傳真 (Fax)
                                    </h3>
                                    <button onclick="addListItem('faxes')" class="text-indigo-600 text-xs font-black">+
                                        新增</button>
                                </div>
                                <div id="list-faxes" class="space-y-2"></div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-slate-100 pb-2">
                                    <h3
                                        class="text-sm font-black text-indigo-600 uppercase tracking-widest flex items-center gap-2">
                                        <i data-lucide="mail" class="w-4 h-4"></i> 信箱 (Email)
                                    </h3>
                                    <button onclick="addListItem('emails')" class="text-indigo-600 text-xs font-black">+
                                        新增</button>
                                </div>
                                <div id="list-emails" class="space-y-2"></div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-slate-100 pb-2">
                                    <h3
                                        class="text-sm font-black text-indigo-600 uppercase tracking-widest flex items-center gap-2">
                                        <i data-lucide="globe" class="w-4 h-4"></i> 網站 (Website)
                                    </h3>
                                    <button onclick="addListItem('urls')" class="text-indigo-600 text-xs font-black">+
                                        新增</button>
                                </div>
                                <div id="list-urls" class="space-y-2"></div>
                            </div>
                        </div>

                        <!-- 地址結構 -->
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b border-slate-100 pb-2">
                                <h3
                                    class="text-sm font-black text-indigo-600 uppercase tracking-widest flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i> 地址 (Address)
                                </h3>
                                <button id="btn-maps" onclick="openGoogleMaps()"
                                    class="text-xs font-bold text-slate-500 hover:text-indigo-600 flex items-center gap-1 hidden">
                                    <i data-lucide="map" class="w-3 h-3"></i> Google Maps
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">國家 (Country)</label>
                                    <input type="text" id="field-country" placeholder="如：台灣"
                                        class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">郵遞區號 (Postal
                                        Code)</label>
                                    <input type="text" id="field-postalCode" placeholder="如：110204"
                                        class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">縣市 (Region)</label>
                                    <input type="text" id="field-region" placeholder="如：台北市"
                                        class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">鄉鎮市區 (Locality)</label>
                                    <input type="text" id="field-locality" placeholder="如：信義區"
                                        class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">街道地址 (Street
                                        Address)</label>
                                    <input type="text" id="field-streetAddress" placeholder="如：市府路1號"
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">延伸地址 (Extended)</label>
                                    <input type="text" id="field-extendedAddress" placeholder="如：市府大樓○樓○○區"
                                        class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">郵政信箱 (PO Box)</label>
                                    <input type="text" id="field-poBox" placeholder="如：○○郵局第○○號信箱"
                                        class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- 備註與摘要 -->
                        <div class="space-y-4">
                            <h3
                                class="text-sm font-black text-indigo-600 uppercase tracking-widest flex items-center gap-2 border-b border-slate-100 pb-2">
                                <i data-lucide="sticky-note" class="w-4 h-4"></i> 備註 (Note)
                            </h3>
                            <div>
                                <textarea id="field-note" rows="2" placeholder="名片備註..."
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none resize-y"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 除錯區 -->
                <div class="mt-8 pt-4 border-t border-dashed border-slate-300 space-y-4">
                    <div>
                        <button onclick="UXManager.toggleDebug('debugPanel1', 'debugToggleText1', 'OCR與上網搜尋')"
                            class="text-xs font-bold text-slate-400 hover:text-slate-700 transition-colors flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm">
                            <i data-lucide="bug" class="w-4 h-4"></i> <span id="debugToggleText1">顯示 OCR與上網搜尋 原始回應
                                (Debug)</span>
                        </button>
                        <pre id="debugPanel1"
                            class="hidden mt-4 bg-slate-900 text-green-400 p-4 rounded-xl text-xs font-mono whitespace-pre-wrap break-all shadow-inner overflow-y-auto max-h-96"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 頁尾 -->
        <footer class="mt-16 pt-8 pb-12 border-t border-slate-200 text-center">
            <div class="inline-flex flex-col items-center gap-2">
                <div
                    class="flex flex-wrap justify-center items-center gap-x-4 gap-y-2 text-slate-500 text-sm font-medium">
                    <a href="https://github.com/mfhsieh/business-card-express/" target="_blank"
                        class="flex items-center gap-1 hover:text-indigo-600 transition-colors group">
                        <i data-lucide="github"
                            class="w-4 h-4 text-indigo-400 mx-1 group-hover:text-indigo-600 transition-colors"></i>
                        mfhsieh at github
                    </a>
                </div>

                <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW" target="_blank"
                    class="mt-1 flex items-center gap-3 bg-white px-5 py-2 rounded-full border border-slate-200 shadow-sm hover:border-indigo-200 hover:shadow-md transition-all group">
                    <div class="flex items-center gap-1 text-indigo-600 group-hover:text-indigo-700 transition-colors">
                        <i data-lucide="creative-commons" class="w-5 h-5"></i>
                        <i data-lucide="user" class="w-4 h-4"></i>
                        <i data-lucide="circle-slash" class="w-4 h-4"></i>
                        <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                    </div>
                    <span
                        class="text-xs font-black text-slate-600 group-hover:text-indigo-600 transition-colors tracking-wide">
                        CC BY-NC-SA 4.0
                    </span>
                </a>
            </div>
        </footer>
    </div>

    <div id="toast"
        class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 text-sm font-bold opacity-0 pointer-events-none transition-opacity duration-300 w-max max-w-[90vw] text-center">
    </div>

    <!-- 全域載入遮罩 -->
    <div id="globalLoadingOverlay"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white px-8 py-6 rounded-3xl shadow-2xl flex flex-col items-center gap-4 transition-transform duration-300 scale-95"
            id="globalLoadingModal">
            <div class="relative w-12 h-12 flex items-center justify-center">
                <i data-lucide="loader-2" class="absolute inset-0 w-12 h-12 text-indigo-200 animate-spin"></i>
                <i data-lucide="loader-2" class="absolute inset-0 w-12 h-12 text-indigo-600 animate-spin-slow"></i>
                <i data-lucide="sparkles" class="w-5 h-5 text-indigo-600 animate-pulse"></i>
            </div>
            <span id="globalLoadingText" class="text-slate-800 font-black tracking-widest text-lg">AI 處理中...</span>
            <span class="text-slate-400 text-xs font-medium mt-1">請稍候，這可能需要幾秒鐘的時間</span>
        </div>
    </div>

    <!-- 歷史紀錄按鈕 (FAB) -->
    <button id="toggleHistoryBtn"
        class="fixed top-6 right-6 bg-white shrink-0 p-3 rounded-full shadow-lg border border-slate-200 text-slate-600 hover:text-indigo-600 hover:border-indigo-300 hover:shadow-xl transition-all z-40 group">
        <i data-lucide="history" class="w-6 h-6 group-hover:-rotate-12 transition-transform"></i>
    </button>

    <!-- 歷史紀錄側邊面版 -->
    <div id="historyOverlay"
        class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300">
    </div>
    <div id="historyPanel"
        class="fixed top-0 right-0 h-full w-80 bg-slate-50 shadow-[-10px_0_30px_rgba(0,0,0,0.1)] z-50 transform translate-x-full transition-transform duration-300 flex flex-col border-l border-slate-200">
        <div class="p-4 border-b border-slate-200 bg-white flex items-center justify-between shrink-0">
            <div class="flex items-center gap-2 text-indigo-900">
                <i data-lucide="history" class="w-5 h-5"></i>
                <h3 class="font-bold">歷史紀錄</h3>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="clearAllHistory()" title="清空全部"
                    class="p-2 text-slate-400 hover:text-red-500 hover:bg-slate-100 rounded-lg transition-colors">
                    <i data-lucide="trash" class="w-4 h-4"></i>
                </button>
                <button id="closeHistoryBtn"
                    class="p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- 歷史紀錄列表區 -->
        <div id="historyListContainer" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div id="historyEmptyState" class="hidden h-full flex flex-col items-center justify-center text-slate-400">
                <i data-lucide="inbox" class="w-12 h-12 mb-3 opacity-50"></i>
                <p class="text-sm">尚無任何紀錄</p>
            </div>
            <div id="historyListContent" class="space-y-3">
                <!-- 項目由 JS 渲染 -->
            </div>
        </div>
    </div>

    <script>
        /**
         * 名片快手 1.02
         */

        /**
         * 系統設定與預設值
         */
        const apiKey = "";
        const MODEL_NAME = "gemini-2.0-flash";
        const DEBOUNCE_DELAY_MS = 1000; // QR Code 與 UI 更新的防抖延遲 (毫秒)

        /** [提示詞] 名片 OCR、規格化與上網深度搜尋 */
        const PROMPT_OCR = `
你精通光學字元辨識 (OCR)、vCard 3.0 (RFC 2426) 規格，且擅長網路搜尋。
你的任務是從名片影像提取聯絡人資訊，搜尋該聯絡人的組織與該人的背景，最後合併輸出為 JSON 格式。

【任務一: 名片 OCR 與 規格化】
1. 分析影像，優先提取繁體中文 (zh-TW) 與英數字。排除裝飾性文字。
2. 修正 OCR 辨識錯誤，如: "l"/"I"/"1"、"O"/"0" 混淆。
3. 仿照 vCard 3.0 標準欄位 (如: FN, N) 進行資料處理:
   - 全名 (FN): 對應 json 的 fn。必要欄位。
   - 姓名 (N): 依序對應 json 的 lastName, firstName, middleName, prefix, suffix。務必拆解出 lastName 與 firstName。
   - 組織 (ORG): 對應 json 的 orgName 與 orgUnit，拆解為組織名稱與部門。
   - 職稱 (TITLE): 對應 json 的 title。
   - 地址 (ADR): 依序對應 json 的 poBox, extendedAddress, streetAddress, locality, region, postalCode, country。
     - 台灣地址 **務必** 遵守以下規則:
       - "縣、市" (如: 新竹縣、台北市、基隆市) 對應 region。此處的 "市" 是指 "直轄市" (共6個: 台北市、高雄市、台中市、台南市、桃園市、新北市) 與 "省轄市" (共3個: 基隆市、新竹市、嘉義市)，"直轄市" 與 "省轄市" 的地址中，locality 非必要欄位。
       - "鄉、鎮、市、區" (如: 湖口鄉、苑裡鎮、竹北市、大安區) 對應 locality。此處的 "市" 是指 "縣轄市" (如: 新竹縣的竹北市、彰化縣的員林市)；此處的 "區" 是指 "直轄市" 與 "省轄市" 的區 (如: 台北市的大安區、基隆市的中正區)。"直轄市" 與 "省轄市" 的 "區"，若名片地址中未明確寫出，則 locality 保持為空。
       - "路、街、段、巷、弄、號、樓" 對應 streetAddress。已拆解至 region 或 locality 的部分不用放入 streetAddress。
       - "台灣" 為 country 的預設值。
       - streetAddress 中，"段" 前的數字使用中文，如: "○○路二段" 而不是 "○○路2段"。
       - streetAddress 中，"巷、弄、號、樓" 前的數字使用阿拉伯數字，如: "12巷3弄4號5樓"。
   - 電話 (TEL):
     - 對應 json 的 phones: [{"type":"work"|"cell"|"home", "value":"...", "ext":"..."}]。公司電話、手機、住家電話分別對應 work、cell、home。
     - 對應 json 的 faxes: [{"type":"work"|"home", "value":"...", "ext":"..."}]。公司傳真、住家傳真分別對應 work、home。
     - 分機務必放在 ext 欄位。
     - 台灣電話格式不加國碼 (如: 02-1234-5678, 0910-123-456)，非台灣電話務必加國碼 (如: +1-555-123-4567)。
     - 務必將所有電話號碼都納入。
   - 電子郵件 (EMAIL):
     - 對應 json 的 emails: [{"type":"work"|"home", "value":"..."}]。公司郵件、個人郵件分別對應 work、home。
     - 務必將所有郵件都納入。
   - 網站 (URL):
     - 對應 json 的 urls: [{"type":"work"|"home", "value":"..."}]。公司網站、個人網站分別對應 work、home。
     - 務必將所有網站都納入。
4. 檢查
   - locality 中，"直轄市" 與 "省轄市" 的 "區"，若名片地址中未明確寫出，嚴禁猜測。
   - streetAddress 中，"段" 前的數字嚴禁使用阿拉伯數字，務必使用中文。
   - streetAddress 中，"巷、弄、號、樓" 前的數字嚴禁使用中文，務必使用阿拉伯數字。

【任務二: 網路深度搜尋】
1. 根據 "任務一" 取得的 "組織名稱 (orgName)"、"人員全名 (fn)" 及 "職稱 (title)"，啟動 Google Search:
   - 搜尋該組織的網站、產業背景、主要業務、新聞等公開資訊。
   - 搜尋該人員的經歷、新聞、演講、著作等公開資訊。
2. 將搜尋結果彙整為兩個欄位 (嚴禁任何形式的開場白、結語):
   - "companySummary": 約200字，該組織背景摘要
   - "personalSummary": 約200字，該人員專業摘要

回傳純 JSON 欄位: fn, lastName, firstName, middleName, prefix, suffix, orgName, orgUnit, title, poBox, extendedAddress, streetAddress, locality, region, postalCode, country, phones, faxes, emails, urls, note, companySummary, personalSummary。`;

        /** [提示詞] 生成跟進郵件 */
        const GET_PROMPT_EMAIL = (org, name, companySummary, personalSummary) => `
你是一位精通台灣商務文化及禮儀的專家，剛拜訪下列客戶:
- 組織名稱: ${org || '貴公司'}
- 客戶全名: ${name || '○先生/女士'}
- 組織背景: ${companySummary}
- 客戶專業: ${personalSummary}

請撰寫一封簡短的商務拜訪後的致謝電子郵件，內容需包含:
- 簡短的問候。
- 提及今日拜訪的愉快經驗。
- 提及客戶的組織背景。
- 提及客戶的專業能力。
- 提及未來保持聯繫及合作的意願。

語氣需專業、誠懇、熱情，並符合台灣商務禮儀。文字流暢即可，不要過於生硬、不要使用過於制式的問候語。`;

        /** [資料結構] 預設名片資料內容 */
        const DEFAULT_CARD_DATA = {
            fn: "", lastName: "", firstName: "", middleName: "", prefix: "", suffix: "",
            orgName: "", orgUnit: "", title: "",
            region: "", locality: "", streetAddress: "", extendedAddress: "", poBox: "", postalCode: "", country: "台灣",
            note: "", companySummary: "", personalSummary: "", emailDraft: "",
            phones: [], faxes: [], emails: [], urls: [],
            sources: []
        };

        /** [配置] 靜態欄位清單，用於自動化表單同步 */
        const STATIC_FIELDS = [
            'fn', 'lastName', 'firstName', 'middleName', 'prefix', 'suffix',
            'orgName', 'orgUnit', 'title',
            'country', 'postalCode', 'region', 'locality', 'poBox', 'extendedAddress', 'streetAddress',
            'note', 'companySummary', 'personalSummary', 'emailDraft'
        ];

        /**
         * [全域狀態] 應用程式核心狀態物件
         * @property {Object} cardData - 當前名片的所有欄位資料
         * @property {string|null} base64Image - 上傳影像的 Base64 字串
         * @property {string} vCardString - 生成的 vCard 3.0 字串
         * @property {string} rawResponse - AI 原始回傳內容 (Debug 用)
         * @property {boolean} isLoading - 是否正在執行非同步任務
         */
        let state = {
            cardData: JSON.parse(JSON.stringify(DEFAULT_CARD_DATA)),
            base64Image: null,
            vCardString: "",
            rawResponse: "",
            isLoading: false,
            currentHistoryId: null
        };

        /**
         * 輔助工具：檢查值是否有效且非 null
         */
        function isValid(val) {
            if (val === null || val === undefined) return false;
            if (typeof val === 'string') {
                const trimmed = val.trim();
                return trimmed !== "" && trimmed.toLowerCase() !== "null";
            }
            return true;
        }

        /**
         * 輔助工具：防抖函數 (Debounce)
         * 避免頻繁觸發同一函數 (例如 QR Code 產生)
         * @param {Function} func - 要執行的函數
         * @param {number} delay - 延遲毫秒數
         */
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                if (timeoutId) clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        /**
         * 模組 1：AI 核心通訊模組 (AI Service Module)
         * 封裝 Google Gemini API 的通訊邏輯、錯誤處理與重試機制。
         */
        const GeminiService = {
            key: "",
            baseDelay: 1000,
            maxRetries: 5,

            /**
             * 初始化金鑰與重試設定
             * @param {string} key - API Key
             * @param {number} [delay=1000] - 基礎延遲毫秒數
             * @param {number} [retries=5] - 最大重試次數
             */
            init(key, delay, retries) {
                this.key = key;
                if (delay !== undefined) this.baseDelay = delay;
                if (retries !== undefined) this.maxRetries = retries;
            },

            /**
             * [底層] 發送 HTTP 請求至 Gemini API，具備指數退避重試邏輯。
             * @param {Object} payload - 傳送給 API 的 JSON 內容
             * @param {string} [model=MODEL_NAME] - 使用的模型名稱
             * @returns {Object} API 回傳的 JSON 完整物件
             */
            async fetch(payload, model = MODEL_NAME) {
                let currentDelay = this.baseDelay;
                const retries = this.maxRetries;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${this.key}`;

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await window.fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorBody = await response.json().catch(() => ({}));
                            throw new Error(errorBody.error?.message || `API 狀態碼 ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        await new Promise(res => setTimeout(res, currentDelay));
                        currentDelay *= 2;
                    }
                }
            },

            /**
             * 從 API 回應物件中提取最後一段文本內容
             * @param {Object} response - fetch 回傳的物件
             * @returns {string} 提取出的純文字
             */
            extractText(response) {
                const parts = response.candidates?.[0]?.content?.parts || [];
                return parts.length > 0 ? parts[parts.length - 1].text : "";
            },

            /**
             * 將包含 Markdown 代碼區塊的文本解析為 JSON 物件
             * @param {string} text - 原始文本內容
             * @returns {Object} 解析後的物件
             */
            parseJSON(text) {
                if (!text) return {};
                try {
                    // 強化解析：抓取最外層的大括號範圍，避免 AI 產生對話前綴
                    const startIdx = text.indexOf('{');
                    const endIdx = text.lastIndexOf('}');

                    if (startIdx !== -1 && endIdx !== -1 && endIdx >= startIdx) {
                        const jsonStr = text.substring(startIdx, endIdx + 1);
                        return JSON.parse(jsonStr);
                    }

                    // Fallback to old behavior if no brackets found (e.g. valid json without top-level braces, though unexpected here)
                    const cleanText = text.replace(/^```[a-z]*\n?/i, '').replace(/\n?```$/i, '').trim();
                    return JSON.parse(cleanText);
                } catch (e) {
                    console.error("GeminiService.parseJSON 失敗:", e, "內容:", text);
                    throw new Error("AI 回傳格式異常。");
                }
            },

            /**
             * [高階] 封裝對話請求，支援圖片上傳與工具呼叫
             * @param {string} prompt - 提示內容
             * @param {string|null} [imageBase64=null] - 影像 Base64 (選填)
             * @param {Array} [tools=null] - 工具清單，如 Google Search (選填)
             * @returns {Object} API 回傳回應
             */
            async ask(prompt, imageBase64 = null, tools = null) {
                const parts = [{ text: prompt }];
                if (imageBase64) {
                    parts.push({ inlineData: { mimeType: "image/png", data: imageBase64 } });
                }
                const payload = { contents: [{ role: "user", parts }] };
                if (tools) payload.tools = tools;

                return await this.fetch(payload);
            }
        };

        /**
         * 模組 2：影像處理與預載模組 (Image Processing Module)
         * 處理前端影像壓縮，確保符合 API 限制。
         */
        const ImageProcessor = {
            /**
             * 處理 File 物件並轉換為壓縮後的 Base64
             * @param {File} file - input 取得的檔案物件
             * @param {number} [maxSide=1200] - 最大邊長像素值
             * @returns {Promise<string>} 壓縮後的 Base64 字串 (不含頭部)
             */
            async compress(file, maxSide = 1200) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        this.compressDataURL(event.target.result, maxSide).then(resolve).catch(reject);
                    };
                    reader.onerror = () => reject(new Error("檔案讀取失敗"));
                });
            },
            /**
             * 將 DataURL 字串轉換為壓縮後的 Base64
             * @param {string} dataUrl - 原始資料的 DataURL
             * @param {number} [maxSide=1200] - 最大邊長像素值
             * @returns {Promise<string>} 壓縮後的 Base64 字串
             */
            async compressDataURL(dataUrl, maxSide = 1200) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.src = dataUrl;
                    img.onload = () => resolve(this.compressImage(img, maxSide));
                    img.onerror = () => reject(new Error("影像載入失敗"));
                });
            },
            /** 
             * [核心邏輯] 利用 Canvas 畫布進行縮放與降質 
             * @param {HTMLImageElement} img - 載入完成的圖片元素
             * @param {number} [maxSide=1200] - 最大邊長像素值
             * @returns {string} 壓縮後的 Base64 字串
             */
            compressImage(img, maxSide = 1200) {
                const canvas = document.createElement('canvas');
                let { width, height } = img;
                if (width > maxSide || height > maxSide) {
                    if (width > height) { height = Math.round((height * maxSide) / width); width = maxSide; }
                    else { width = Math.round((width * maxSide) / height); height = maxSide; }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                return canvas.toDataURL('image/png').split(',')[1];
            }
        };

        /**
         * 模組 3：vCard 3.0 標準化模組 (Data Transformation Module)
         * 將 JSON 資料物件轉換為 RFC 2426 編碼格式。
         */
        const vCardFormatter = {
            /**
             * 台灣電話號碼格式化
             * 將 +886 或 886 轉為 0，並增加區碼分隔號。
             * @param {string} phone - 原始電話字串
             * @returns {string} 格式化後的電話
             */
            normalizePhone(phone) {
                if (!isValid(phone)) return phone || "";

                // 1. 轉為字串並移除所有非數字與非加號內容
                let cleaned = String(phone).trim().replace(/[^\d+]/g, '');

                // 2. 處理國碼：將 +886 或 886 轉回台灣本地 0 開頭格式
                if (cleaned.startsWith('+886')) cleaned = '0' + cleaned.slice(4);
                else if (cleaned.startsWith('886')) cleaned = '0' + cleaned.slice(3);

                // 3. 針對台灣本地號碼 (0 開頭) 進行格式化
                if (cleaned.startsWith('0')) {
                    // 3.1 手機號碼：09XX-XXX-XXX
                    if (/^09\d{8}$/.test(cleaned)) return `${cleaned.slice(0, 4)}-${cleaned.slice(4, 7)}-${cleaned.slice(7)}`;

                    // 3.2 特殊三碼區碼 (苗栗、南投、金門、澎湖、台東)
                    const area3 = ['037', '049', '082', '069', '089'];
                    if (area3.includes(cleaned.slice(0, 3))) return `${cleaned.slice(0, 3)}-${cleaned.slice(3)}`;

                    // 3.3 特殊四碼區碼 (馬祖)
                    if (cleaned.startsWith('0836')) return `${cleaned.slice(0, 4)}-${cleaned.slice(4)}`;

                    // 3.4 標準二碼區碼 (北中南各大城市)
                    if (/^0[2-8]/.test(cleaned)) {
                        let area = cleaned.slice(0, 2);
                        let body = cleaned.slice(2);
                        // 台北區碼 02 且為 8 碼電話時，格式為 02-XXXX-XXXX
                        if (area === '02' && body.length === 8) return `${area}-${body.slice(0, 4)}-${body.slice(4)}`;
                        // 其餘為 0X-XXXXXXX
                        return `${area}-${body}`;
                    }
                }

                // 4. 若非 0 開頭或不符合台灣規則，回傳清理後的原始字串
                return cleaned;
            },

            /** 
             * 生成 vCard 的修訂時間戳記 (REV) 
             * @returns {string} 格式化後的時間戳記字串
             */
            formatREV() {
                return new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            },

            /**
             * [核心] 產生完整 vCard 3.0 字串
             * @param {Object} d - 聯絡人資料物件
             * @returns {string} vCard 格式文本
             */
            generate(d) {
                // 1. 輔助函數：檢查是否包含非 ASCII 字元 (用於決定是否標註 UTF-8)
                const hasNonAscii = (str) => /[^\x20-\x7E]/.test(str);
                const getUtf8 = (str) => hasNonAscii(str) ? ";CHARSET=UTF-8" : "";

                // 2. 初始化 vCard 陣列與 Header (版本 3.0)
                const parts = ["BEGIN:VCARD", "VERSION:3.0", `REV:${this.formatREV()}`, "CATEGORIES;CHARSET=UTF-8:名片快手"];

                // 3. 處理全名 (FN): 優先使用 fn 欄位，若無則組合姓與名
                const fnValue = isValid(d.fn) ? d.fn : ((isValid(d.lastName) ? d.lastName : '') + (isValid(d.firstName) ? d.firstName : '') || '聯絡人');
                parts.push(`FN${getUtf8(fnValue)}:${fnValue}`);

                // 4. 處理姓名結構 (N): 格式為 姓;名;中間名;前綴;後綴
                const nValue = [d.lastName, d.firstName, d.middleName, d.prefix, d.suffix].map(v => isValid(v) ? v : '').join(';');
                parts.push(`N${getUtf8(nValue)}:${nValue}`);

                // 5. 處理組織與部門 (ORG)
                if (isValid(d.orgName) || isValid(d.orgUnit)) {
                    let orgStr = (d.orgName || '');
                    if (isValid(d.orgUnit)) orgStr += ';' + d.orgUnit;
                    parts.push(`ORG${getUtf8(orgStr)}:${orgStr}`);
                }

                // 6. 處理職稱 (TITLE)
                if (isValid(d.title)) parts.push(`TITLE${getUtf8(d.title)}:${d.title}`);

                // 7. 處理地址 (ADR): 格式為 郵政信箱;延伸地址;街道地址;城市;區域;郵遞區號;國家
                const adrValue = [d.poBox, d.extendedAddress, d.streetAddress, d.locality, d.region, d.postalCode, d.country].map(v => isValid(v) ? v : '').join(';');
                parts.push(`ADR;TYPE=WORK${getUtf8(adrValue)}:${adrValue}`);

                // 8. 處理多組電話與傳真
                (d.phones || []).forEach(p => {
                    if (isValid(p.value)) {
                        let type = p.type === 'cell' ? 'CELL' : (p.type === 'home' ? 'HOME' : 'WORK');
                        let num = String(p.value).replace(/[^\d+\-() ]/g, '');
                        if (isValid(p.ext)) num += `,${String(p.ext).trim()}`;
                        parts.push(`TEL;TYPE=${type},VOICE:${num}`);
                    }
                });

                (d.faxes || []).forEach(f => {
                    if (isValid(f.value)) {
                        let type = f.type === 'home' ? 'HOME' : 'WORK';
                        let num = String(f.value).replace(/[^\d+\-() ]/g, '');
                        if (isValid(f.ext)) num += `,${String(f.ext).trim()}`;
                        parts.push(`TEL;TYPE=${type},FAX:${num}`);
                    }
                });

                // 9. 處理多組電子郵件
                (d.emails || []).forEach(e => {
                    if (isValid(e.value)) {
                        let type = e.type === 'home' ? 'HOME' : 'WORK';
                        parts.push(`EMAIL;TYPE=${type}:${e.value.trim()}`);
                    }
                });

                // 10. 處理多組網站連結
                (d.urls || []).forEach(w => {
                    if (isValid(w.value)) {
                        let type = w.type === 'home' ? 'HOME' : 'WORK';
                        parts.push(`URL;TYPE=${type}:${w.value.trim()}`);
                    }
                });

                // 11. 處理備註 (NOTE): 將換行符號轉為 \n
                if (isValid(d.note)) {
                    const cleanNote = d.note.replace(/\n/g, '\\n');
                    parts.push(`NOTE${getUtf8(cleanNote)}:${cleanNote}`);
                }

                // 12. 結束標記並過濾掉無效行，最後合併為字串
                parts.push("END:VCARD");
                return parts.filter(line => line && line.includes(':') && !line.endsWith(':')).join("\n");
            }
        };

        /**
         * 模組 4：UX 狀態管理器 (UX Manager)
         * 負責 UI 反饋、Loading 顯示、錯誤提示與區塊展開/收合。
         */
        const UXManager = {
            /** 
             * 初始化模組，綁定 textarea 自動調整高度事件 
             * @returns {void}
             */
            init() {
                const textareas = ['field-companySummary', 'field-personalSummary', 'emailDraftText', 'field-note'];
                textareas.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', () => this.autoResize(el));
                });
            },
            /** 
             * 顯示 Toast 訊息 
             * @param {string} msg - 要顯示的訊息內容
             * @returns {void}
             */
            toast(msg) {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.remove('opacity-0', 'pointer-events-none');
                setTimeout(() => toast.classList.add('opacity-0', 'pointer-events-none'), 3000);
            },
            /** 
             * 設定按鈕的全域載入遮罩狀態 
             * @param {boolean} isLoading - 是否處於載入狀態
             * @param {string} [text="AI 處理中..."] - 載入時欲顯示的文字
             * @returns {void}
             */
            setLoading(isLoading, text = "AI 處理中...") {
                const btn = document.getElementById('identifyBtn');
                if (btn) btn.disabled = isLoading;

                const overlay = document.getElementById('globalLoadingOverlay');
                const modal = document.getElementById('globalLoadingModal');
                const textEl = document.getElementById('globalLoadingText');

                if (overlay && modal && textEl) {
                    textEl.textContent = text;
                    if (isLoading) {
                        overlay.classList.remove('opacity-0', 'pointer-events-none');
                        setTimeout(() => modal.classList.remove('scale-95'), 10);
                    } else {
                        modal.classList.add('scale-95');
                        overlay.classList.add('opacity-0', 'pointer-events-none');
                    }
                }
            },
            /** 
             * 顯示錯誤訊息區塊 
             * @param {string} msg - 錯誤訊息內容
             * @returns {void}
             */
            showError(msg) {
                const err = document.getElementById('errorMessage');
                const text = document.getElementById('errorText');
                if (text) text.textContent = msg;
                if (err) err.classList.remove('hidden');
                document.getElementById('debugPanel1').classList.remove('hidden');
            },
            /** 
             * 文字框自動依內容調整高度 
             * @param {HTMLElement} el - 需要被調整高度的 textarea 元素
             * @returns {void}
             */
            autoResize(el) {
                if (!el) return;
                el.style.height = 'auto';
                el.style.height = (el.scrollHeight) + 'px';
            },
            /** 
             * 切換除錯面版顯示 
             * @param {string} panelId - 面板 DOM ID
             * @param {string} textId - 按鈕文字 DOM ID
             * @param {string} phaseName - 階段名稱 (用於按鈕文字顯示)
             * @returns {void}
             */
            toggleDebug(panelId, textId, phaseName) {
                const panel = document.getElementById(panelId);
                const isHidden = panel.classList.toggle('hidden');
                document.getElementById(textId).textContent = isHidden ? `顯示 ${phaseName} 原始回應 (Debug)` : `隱藏 ${phaseName} 原始回應`;
            },
            /** 
             * 切換 UI 區塊展開或收合狀態 
             * @param {string} contentId - 內容區塊 DOM ID
             * @param {string} iconId - 圖示 DOM ID
             * @returns {void}
             */
            toggleSection(contentId, iconId) {
                const content = document.getElementById(contentId);
                const isHidden = content.classList.toggle('hidden');
                const icon = document.getElementById(iconId);
                if (icon) icon.classList.toggle('rotate-180', isHidden);
                if (!isHidden) setTimeout(() => { content.querySelectorAll('textarea').forEach(ta => this.autoResize(ta)); }, 10);
            }
        };

        /**
         * 模組 5：表單欄位自動同步器 (Form Binder)
         * 負責資料物件與 UI 欄位之間的雙向同步，減少手動操作 DOM 的冗餘程式碼。
         */
        const FormBinder = {
            /**
             * [單向同步] 將資料物件的內容填入對應的 UI 欄位。
             * @param {Object} data - 來源資料物件。
             * @param {Array<string>} keys - 要同步的欄位鍵值清單。
             */
            sync(data, keys) {
                keys.forEach(key => {
                    const el = document.getElementById(`field-${key}`);
                    if (el) el.value = isValid(data[key]) ? data[key] : "";
                });
            },

            /**
             * [雙向綁定] 為所有欄位註冊輸入事件，自動更新狀態物件並觸發回呼。
             * @param {Array<string>} keys - 欄位鍵值清單。
             * @param {Function} onUpdate - 資料更新後的回呼函數 (例如更新預覽)。
             */
            bind(keys, onUpdate) {
                keys.forEach(key => {
                    const el = document.getElementById(`field-${key}`);
                    if (el) {
                        el.addEventListener('input', (e) => {
                            state.cardData[key] = e.target.value;
                            if (onUpdate) onUpdate();
                        });
                    }
                });
            }
        };

        /**
         * 模組 6：地圖服務模組 (Map Service)
         * 負責處理地址格式化與地圖跳轉邏輯。
         */
        const MapService = {
            /**
             * 根據名片資料合成 Google Maps 搜尋 URL
             * @param {Object} d - 聯絡人資料物件
             * @returns {string} 完整的 Google Maps 搜尋連結
             */
            getGoogleMapsUrl(d) {
                const fullAddress = [d.country, d.region, d.locality, d.streetAddress].filter(v => isValid(v)).join(', ');
                if (!fullAddress) return "";
                return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;
            },
            /** 
             * 開啟地圖頁面
             * @param {Object} d - 聯絡人資料物件
             * @returns {void} 
             */
            openGoogleMaps(d) {
                const url = this.getGoogleMapsUrl(d);
                if (url) window.open(url, '_blank');
            }
        };

        /**
         * 模組 7：導出服務模組 (Export Service)
         * 負責處理檔案下載、剪貼簿複製等與外部匯出相關的瀏覽器行為。
         */
        const ExportService = {
            /**
             * 觸發瀏覽器下載檔案
             * @param {string} filename - 存檔檔名
             * @param {string} content - 檔案內容
             * @param {string} [mimeType='text/vcard'] - MIME 類型
             */
            download(filename, content, mimeType = 'text/vcard') {
                if (!content) return;
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },
            /**
             * 封裝剪貼簿複製功能
             * @param {string} text - 欲複製的內容
             * @returns {boolean} 是否成功執行
             */
            copyToClipboard(text) {
                if (!text) return false;
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                try {
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    return true;
                } catch (err) {
                    console.error("複製失敗:", err);
                    document.body.removeChild(el);
                    return false;
                }
            }
        };

        /**
         * 模組 8：本地資料庫服務模組 (Database Service)
         * 負責使用 IndexedDB 在瀏覽器端自動保存已辨識的名片歷史紀錄。
         */
        const DatabaseService = {
            dbName: 'NCS_HistoryDB',
            storeName: 'cards',
            version: 1,
            db: null,

            /**
             * 初始化並開啟 IndexedDB
             * @returns {Promise<void>}
             */
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            // 使用 timestamp 作為 keyPath 確保唯一與排序
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };

                    request.onerror = (event) => {
                        console.error("IndexedDB 初始化失敗:", event.target.error);
                        reject(event.target.error);
                    };
                });
            },

            /**
             * 儲存單筆名片紀錄 (支援更新既有紀錄)
             * @param {Object} cardData - 名片 JSON 資料
             * @param {string} base64Image - 原始影像字串
             * @param {number|null} [existingId=null] - 既有紀錄 ID
             * @returns {Promise<number>} 回傳建立的 ID
             */
            async saveCard(cardData, base64Image, existingId = null) {
                if (!this.db) return null;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const now = Date.now();
                    const record = {
                        id: existingId || now, // 沿用舊 ID 或產生新 ID
                        timestamp: existingId || now, // 保持原本建檔排序
                        cardData: JSON.parse(JSON.stringify(cardData)), // 深度拷貝避免參照修改
                        base64Image: base64Image
                    };
                    const request = store.put(record);
                    request.onsuccess = () => resolve(record.id);
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            /**
             * 取得所有歷史紀錄，依照時間降序排列
             * @returns {Promise<Array>} 歷史紀錄陣列
             */
            async getAllCards() {
                if (!this.db) return [];
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const list = request.result || [];
                        list.sort((a, b) => b.timestamp - a.timestamp); // 降序：最新的在前面
                        resolve(list);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            /**
             * 刪除指定歷史紀錄
             * @param {number} id - 紀錄 ID
             * @returns {Promise<void>}
             */
            async deleteCard(id) {
                if (!this.db) return;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            /**
             * 清空所有歷史紀錄
             * @returns {Promise<void>}
             */
            async clearAll() {
                if (!this.db) return;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            }
        };

        /**
         * 模組 9：歷史紀錄介面模組 (History Manager)
         * 負責處理歷史紀錄選單的開關、渲染、載入、刪除等與 UI 之互動邏輯。
         */
        const HistoryManager = {
            /**
             * 初始化歷史紀錄面板的事件監聽
             * @returns {void}
             */
            init() {
                // 歷史紀錄面版開關事件
                const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
                const closeHistoryBtn = document.getElementById('closeHistoryBtn');
                const historyOverlay = document.getElementById('historyOverlay');
                const historyPanel = document.getElementById('historyPanel');

                this.toggleHistoryPanel = () => {
                    const isHidden = historyOverlay.classList.contains('hidden');
                    if (isHidden) {
                        historyOverlay.classList.remove('hidden');
                        // 確保 display block生效後才觸發動畫
                        setTimeout(() => {
                            historyOverlay.classList.remove('opacity-0');
                            historyPanel.classList.remove('translate-x-full');
                        }, 10);
                    } else {
                        historyOverlay.classList.add('opacity-0');
                        historyPanel.classList.add('translate-x-full');
                        setTimeout(() => historyOverlay.classList.add('hidden'), 300);
                    }
                };

                if (toggleHistoryBtn) toggleHistoryBtn.onclick = this.toggleHistoryPanel;
                if (closeHistoryBtn) closeHistoryBtn.onclick = this.toggleHistoryPanel;
                if (historyOverlay) historyOverlay.onclick = this.toggleHistoryPanel;
            },

            /**
             * 渲染歷史紀錄清單至 UI 畫面
             * @returns {Promise<void>}
             */
            async render() {
                const listEl = document.getElementById('historyListContent');
                const emptyEl = document.getElementById('historyEmptyState');
                if (!listEl || !emptyEl) return;

                try {
                    const cards = await DatabaseService.getAllCards();

                    if (cards.length === 0) {
                        listEl.classList.add('hidden');
                        emptyEl.classList.remove('hidden');
                        return;
                    }

                    emptyEl.classList.add('hidden');
                    listEl.classList.remove('hidden');

                    listEl.innerHTML = cards.map(c => {
                        const date = new Date(c.timestamp).toLocaleString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const name = c.cardData.fn || '未命名聯絡人';
                        const org = c.cardData.orgName || '無公司資訊';
                        const imgPreview = c.base64Image ? `<img src="data:image/png;base64,${c.base64Image}" class="w-10 h-10 object-cover rounded-lg border border-slate-200 shrink-0">` : `<div class="w-10 h-10 bg-slate-100 rounded-lg border border-slate-200 shrink-0 flex items-center justify-center"><i data-lucide="image" class="w-4 h-4 text-slate-400"></i></div>`;

                        return `
                            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm hover:shadow-md hover:border-indigo-100 transition-all group flex items-center gap-3 cursor-pointer" onclick="HistoryManager.loadItem(${c.id})">
                                ${imgPreview}
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-sm font-bold text-slate-800 truncate">${name}</h4>
                                    <p class="text-xs text-slate-500 truncate">${org}</p>
                                    <p class="text-[10px] text-slate-400 mt-1 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${date}</p>
                                </div>
                                <button onclick="event.stopPropagation(); HistoryManager.deleteItem(${c.id})" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors shrink-0">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                    }).join('');
                    lucide.createIcons();
                } catch (err) {
                    console.error("讀取歷史紀錄失敗:", err);
                }
            },

            /**
             * 載入單筆歷史紀錄至目前畫面狀態中
             * @param {number} id - 紀錄 ID
             * @returns {Promise<void>}
             */
            async loadItem(id) {
                try {
                    const cards = await DatabaseService.getAllCards();
                    const target = cards.find(c => c.id === id);
                    if (target) {
                        state.cardData = JSON.parse(JSON.stringify(target.cardData));
                        state.base64Image = target.base64Image;
                        state.currentHistoryId = id;

                        // 關閉歷史面版
                        if (this.toggleHistoryPanel) {
                            const overlay = document.getElementById('historyOverlay');
                            if (!overlay.classList.contains('hidden')) {
                                this.toggleHistoryPanel();
                            }
                        }

                        // 恢復圖片預覽
                        if (state.base64Image) {
                            const preview = document.getElementById('previewImage');
                            preview.src = `data:image/png;base64,${state.base64Image}`;
                            preview.classList.remove('hidden');
                            document.getElementById('uploadPlaceholder').classList.add('hidden');

                            const btn = document.getElementById('identifyBtn');
                            btn.disabled = false;
                            btn.classList.replace('bg-slate-100', 'bg-indigo-600');
                            btn.classList.replace('text-slate-400', 'text-white');
                            btn.classList.add('shadow-xl', 'hover:bg-indigo-700');
                        }

                        syncDataToUI();
                        UXManager.toast("已從歷史紀錄載入");
                    }
                } catch (err) {
                    UXManager.toast("載入失敗: " + err.message);
                }
            },

            /**
             * 刪除指定歷史紀錄
             * @param {number} id - 紀錄 ID
             * @returns {Promise<void>}
             */
            async deleteItem(id) {
                if (!confirm("確定要刪除這筆紀錄嗎？")) return;
                try {
                    await DatabaseService.deleteCard(id);
                    this.render();
                    UXManager.toast("紀錄已刪除");
                } catch (err) {
                    UXManager.toast("刪除失敗: " + err.message);
                }
            },

            /**
             * 清空所有歷史紀錄
             * @returns {Promise<void>}
             */
            async clearAll() {
                if (!confirm("警告：這將會永久刪除所有保留在瀏覽器內的歷史紀錄，確定嗎？")) return;
                try {
                    await DatabaseService.clearAll();
                    this.render();
                    UXManager.toast("所有歷史紀錄已清空");
                } catch (err) {
                    UXManager.toast("清空失敗: " + err.message);
                }
            }
        };

        /**
         * 模組 10：表單驗證模組 (Validator Service)
         * 負責檢查 Email、網址是否符合基本格式。
         */
        const Validator = {
            /**
             * 檢查電子郵件格式是否有效
             * @param {string} email - 電子郵件字串
             * @returns {boolean} 是否為有效格式
             */
            isValidEmail(email) {
                if (!email) return true; // 允許空白
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            },
            /**
             * 檢查網址格式是否有效
             * @param {string} url - 網址字串
             * @returns {boolean} 是否為有效網址
             */
            isValidURL(url) {
                if (!url) return true; // 允許空白
                try {
                    new URL(url.startsWith('http') ? url : `https://${url}`);
                    return true;
                } catch {
                    return false;
                }
            }
        };

        window.onload = async () => {
            lucide.createIcons();
            GeminiService.init(apiKey);
            UXManager.init();

            // 初始化本地資料庫並載入歷史清單
            try {
                await DatabaseService.init();
                HistoryManager.init();
                HistoryManager.render();
            } catch (err) {
                console.warn("無法啟動本地歷史紀錄功能:", err);
            }

            // 初始化表單雙向綁定：取代原本分散的 setupFormListeners 邏輯
            FormBinder.bind(STATIC_FIELDS, debouncedUpdateVCardPreview);

            setupDragAndDrop();

            document.getElementById('identifyBtn').onclick = identifyCard;
            document.getElementById('saveVcfBtn').onclick = downloadVCard;
            document.getElementById('copyVcfBtn').onclick = copyVCardContent;
            document.getElementById('generateEmailBtn').onclick = generateEmailDraft;

            window.clearAllHistory = () => HistoryManager.clearAll();
        };

        /**
         * [初始化] 設定拖放上傳與點擊上傳的事件監聽
         * - 處理 `dropZone` 的 onClick, onDragOver, onDragLeave, onDrop 事件
         * - 處理隱藏的 `fileInput` 的 onChange 事件
         * - 處理全域的剪貼簿 `paste` 事件以支援 Ctrl+V 貼上圖片
         */
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            // 點擊上傳區域觸發隱藏的 file input
            dropZone.onclick = () => fileInput.click();

            // 處理拖曳進入、離開與放開事件
            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-500', 'bg-indigo-50/30'); };
            dropZone.ondragleave = (e) => { e.preventDefault(); dropZone.classList.remove('border-indigo-500', 'bg-indigo-50/30'); };
            dropZone.ondrop = async (e) => {
                e.preventDefault(); dropZone.classList.remove('border-indigo-500', 'bg-indigo-50/30');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) await processFile(e.dataTransfer.files[0]);
            };

            // 處理檔案選擇變更
            fileInput.onchange = async (e) => { if (e.target.files && e.target.files.length > 0) await processFile(e.target.files[0]); };

            // 處理全域剪貼簿貼上事件 (Ctrl+V / Cmd+V)
            document.addEventListener('paste', async (e) => {
                // 若焦點在輸入框內，則不攔截 (讓使用者可以正常貼上文字)
                const activeTag = document.activeElement ? document.activeElement.tagName.toLowerCase() : '';
                if (activeTag === 'input' || activeTag === 'textarea') return;

                const items = (e.clipboardData || window.event?.clipboardData).items;
                if (!items) return;

                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = items[i].getAsFile();
                        if (file) await processFile(file);
                        break; // 找到第一張圖片就處理並退出
                    }
                }
            });
        }

        /**
         * [處理流程] 處理選取的影像檔案
         * 包含壓縮、預覽顯示以及解鎖辨識按鈕。
         * @param {File} file - 圖片檔案物件
         */
        async function processFile(file) {
            if (!file || !file.type.startsWith('image/')) { UXManager.toast("請上傳有效的圖片檔案"); return; }
            resetEmailDraft();
            try {
                // 1. 影像壓縮與 Base64 轉換
                const base64 = await ImageProcessor.compress(file, 1200);
                state.base64Image = base64;

                // 2. 更新預覽 UI
                const preview = document.getElementById('previewImage');
                preview.src = `data:image/png;base64,${base64}`;
                preview.classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');

                // 3. 解鎖並強化辨識按鈕樣式
                const btn = document.getElementById('identifyBtn');
                btn.disabled = false;
                btn.classList.replace('bg-slate-100', 'bg-indigo-600');
                btn.classList.replace('text-slate-400', 'text-white');
                btn.classList.add('shadow-xl', 'hover:bg-indigo-700');

                UXManager.toast("影像準備就緒");
            } catch (err) { UXManager.showError("影像處理失敗：" + err.message); }
        }

        /**
         * [核心邏輯] AI 辨識主程序
         * 包含影像 OCR 辨識與上網深度搜尋。
         * - 依賴 `state.base64Image` 作為分析來源
         * - 呼叫 Gemini API 取得結構化 JSON 聯絡人資料
         * - 處理容錯機制與清單資料初始化
         * - 呼叫 `syncDataToUI()` 更新畫面
         * @async
         * @returns {Promise<void>}
         */
        async function identifyCard() {
            if (!state.base64Image) return;
            resetEmailDraft();
            UXManager.setLoading(true, "AI 影像辨識與上網搜尋中...");

            // 清空舊的 Debug 資訊
            document.getElementById('debugPanel1').textContent = "";

            try {
                // 執行 OCR 與上網搜尋
                const result1 = await GeminiService.ask(PROMPT_OCR, state.base64Image, [{ googleSearch: {} }]);
                document.getElementById('debugPanel1').textContent = JSON.stringify(result1, null, 2);

                const text1 = GeminiService.extractText(result1);
                const parsedData = GeminiService.parseJSON(text1);

                // 防呆容錯處理：確保所有的清單資料型態為陣列
                ['phones', 'faxes', 'emails', 'urls'].forEach(key => {
                    if (!Array.isArray(parsedData[key])) parsedData[key] = [];
                });

                // 預先處理號碼格式
                if (parsedData.phones.length > 0) parsedData.phones = parsedData.phones.map(p => ({ ...p, value: vCardFormatter.normalizePhone(p.value) }));
                if (parsedData.faxes.length > 0) parsedData.faxes = parsedData.faxes.map(f => ({ ...f, value: vCardFormatter.normalizePhone(f.value) }));

                // 提取來源連結
                const candidate1 = result1.candidates?.[0];
                const metadata = candidate1?.groundingMetadata;
                const rawSources = metadata?.groundingChunks || metadata?.groundingAttributions || [];
                const sources = rawSources.map(a => ({ uri: a.web?.uri, title: a.web?.title })).filter(s => s.uri && s.title);

                parsedData.sources = sources;

                // 更新狀態並同步 UI
                state.cardData = { ...JSON.parse(JSON.stringify(DEFAULT_CARD_DATA)), ...parsedData };
                syncDataToUI();

                // 成功載入與渲染後，非同步儲存到 IndexedDB
                DatabaseService.saveCard(state.cardData, state.base64Image)
                    .then(id => {
                        state.currentHistoryId = id;
                        HistoryManager.render();
                    })
                    .catch(err => console.warn("歷史紀錄存檔失敗", err));

                UXManager.toast("影像辨識與上網搜尋完成！");
            } catch (err) { UXManager.showError("處理失敗：" + err.message); }
            finally { UXManager.setLoading(false); }
        }

        /**
         * [功能] 重置郵件草稿區域並隱藏
         */
        function resetEmailDraft() {
            state.cardData.emailDraft = "";
            const draftContainer = document.getElementById('emailDraftContainer');
            if (draftContainer) draftContainer.classList.add('hidden');
            const textArea = document.getElementById('field-emailDraft');
            if (textArea) { textArea.value = ""; textArea.style.height = 'auto'; }
        }

        /**
         * [非同步] 根據目前的辨識與搜尋結果，自動撰寫跟進郵件
         * - 依賴 `state.cardData` 中的 orgName, fn, companySummary, personalSummary
         * - 呼叫 API 並將結果填入 textArea
         * @async
         * @returns {Promise<void>}
         */
        async function generateEmailDraft() {
            const d = state.cardData;
            if (!isValid(d.fn) && !isValid(d.orgName)) { UXManager.toast("請先辨識資訊"); return; }
            const draftContainer = document.getElementById('emailDraftContainer');
            const loadingOverlay = document.getElementById('emailLoading');
            const textArea = document.getElementById('field-emailDraft');

            // 1. 確保區塊顯示並打開收合
            draftContainer.classList.remove('hidden');
            const content = document.getElementById('emailDraftContent');
            if (content && content.classList.contains('hidden')) {
                UXManager.toggleSection('emailDraftContent', 'emailDraftIcon');
            }

            // 2. 清空舊內容並顯示 Loading
            textArea.value = "";
            UXManager.autoResize(textArea);
            loadingOverlay.classList.remove('hidden');

            // 3. 滾動到區塊位置
            draftContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

            const prompt = GET_PROMPT_EMAIL(d.orgName, d.fn, d.companySummary, d.personalSummary);

            try {
                const result = await GeminiService.ask(prompt);
                const text = GeminiService.extractText(result);
                textArea.value = text ? text.trim() : "生成失敗";
                state.cardData.emailDraft = textArea.value;
                UXManager.autoResize(textArea);

                // 自動儲存信件草稿到歷史紀錄中
                if (state.currentHistoryId) {
                    DatabaseService.saveCard(state.cardData, state.base64Image, state.currentHistoryId)
                        .then(() => HistoryManager.render())
                        .catch(err => console.warn("自動寫入歷史紀錄失敗", err));
                }

            } catch (err) { textArea.value = "發生錯誤：" + err.message; state.cardData.emailDraft = ""; }
            finally { loadingOverlay.classList.add('hidden'); }
        }

        /**
         * [功能] 複製郵件草稿至剪貼簿
         */
        window.copyEmailDraft = () => {
            const text = document.getElementById('field-emailDraft').value;
            if (ExportService.copyToClipboard(text)) {
                UXManager.toast("草稿已複製！");
            }
        };

        /**
         * [資料流] 將當前狀態資料同步渲染至 UI 畫面
         * 包含靜態欄位、摘要顯示、來源標籤與所有動態清單。
         * @returns {void}
         */
        function syncDataToUI() {
            const d = state.cardData;

            // 1. 同步全名、公司、職稱等靜態 Input/Textarea
            FormBinder.sync(d, STATIC_FIELDS);

            // 2. 處理摘要顯示邏輯
            const hasCompany = isValid(d.companySummary);
            const hasPersonal = isValid(d.personalSummary);
            const hasEmailDraft = isValid(d.emailDraft);

            if (hasCompany || hasPersonal || hasEmailDraft) {
                document.getElementById('summaryContainer').classList.remove('hidden');
                document.getElementById('companySummaryBlock').classList.toggle('hidden', !hasCompany);
                document.getElementById('personalSummaryBlock').classList.toggle('hidden', !hasPersonal);

                if (hasEmailDraft) {
                    document.getElementById('emailDraftContainer').classList.remove('hidden');
                    // 確保內容區塊不會是隱藏狀態
                    const content = document.getElementById('emailDraftContent');
                    if (content) content.classList.remove('hidden');
                    const icon = document.getElementById('emailDraftIcon');
                    if (icon) icon.classList.remove('rotate-180');
                } else {
                    document.getElementById('emailDraftContainer').classList.add('hidden');
                }

                // 多次嘗試更新高度，確保 display:none 轉換與動畫過程能抓到正確的 scrollHeight
                [0, 50, 150, 300].forEach(delay => {
                    setTimeout(() => {
                        if (hasCompany) UXManager.autoResize(document.getElementById('field-companySummary'));
                        if (hasPersonal) UXManager.autoResize(document.getElementById('field-personalSummary'));
                        if (hasEmailDraft) UXManager.autoResize(document.getElementById('field-emailDraft'));
                    }, delay);
                });
            } else { document.getElementById('summaryContainer').classList.add('hidden'); }

            // 3. 渲染參考來源標籤
            const sourcesList = document.getElementById('sourcesList');
            const sourcesBlock = document.getElementById('sourcesBlock');
            if (d.sources && d.sources.length > 0) {
                sourcesBlock.classList.remove('hidden');
                sourcesList.innerHTML = d.sources.map(s => `
                    <a href="${s.uri}" target="_blank" class="flex items-center gap-1.5 px-3 py-1 bg-slate-50 border border-slate-100 rounded-full text-[10px] text-indigo-500 hover:bg-indigo-50 font-bold transition-all shadow-sm">
                        <i data-lucide="globe" class="w-3 h-3"></i> ${s.title || '來源'}
                    </a>
                `).join('');
                lucide.createIcons();
            } else { sourcesBlock.classList.add('hidden'); }

            // 4. 渲染所有動態清單
            renderList('phones'); renderList('faxes'); renderList('emails'); renderList('urls');

            // 5. 更新右側預覽 (QR Code & Google Maps)
            debouncedUpdateVCardPreview();
        }

        /**
         * [UI 渲染] 渲染動態陣列清單 (電話、信箱等)
         * - 生成 DOM 節點並插入對應的 container 中
         * - 處理 phone, faxes, emails, urls 不同的 placeholder 與選項
         * @param {string} type - 清單類別 ('phones', 'faxes', 'emails', 'urls')
         * @returns {void}
         */
        function renderList(type) {
            const container = document.getElementById(`list-${type}`);
            if (!container) return; container.innerHTML = "";
            const items = state.cardData[type] || [];
            if (items.length === 0) { container.innerHTML = `<div class="text-xs text-slate-400 italic py-1 px-2">無資料</div>`; return; }

            items.forEach((item, idx) => {
                let valKey = 'value';
                let div = document.createElement('div');
                div.className = "flex flex-col gap-1 w-full group";

                // 設定類別下拉選單
                let optionsHTML = '';
                if (type === 'phones') {
                    optionsHTML = `<option value="work" ${item.type === 'work' ? 'selected' : ''}>公司</option><option value="cell" ${item.type === 'cell' ? 'selected' : ''}>手機</option><option value="home" ${item.type === 'home' ? 'selected' : ''}>住家</option>`;
                } else if (type === 'faxes') {
                    optionsHTML = `<option value="work" ${item.type === 'work' ? 'selected' : ''}>公司</option><option value="home" ${item.type === 'home' ? 'selected' : ''}>住家</option>`;
                } else {
                    optionsHTML = `<option value="work" ${item.type === 'work' ? 'selected' : ''}>公司</option><option value="home" ${item.type === 'home' ? 'selected' : ''}>個人</option>`;
                }

                // 設定輸入欄位
                let inputsHTML = '';
                let validationMsg = '';
                if (type === 'phones' || type === 'faxes') {
                    inputsHTML = `
                        <input type="text" value="${item[valKey] || ''}" placeholder="號碼" oninput="updateListItem('${type}', ${idx}, '${valKey}', this.value)" class="flex-1 min-w-0 px-2.5 py-2 rounded-lg bg-white border border-slate-200 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <input type="text" value="${item.ext || ''}" placeholder="分機" oninput="updateListItem('${type}', ${idx}, 'ext', this.value)" class="w-14 shrink-0 px-2 py-2 rounded-lg bg-white border border-slate-200 text-sm outline-none text-center focus:ring-2 focus:ring-indigo-500 transition-all">
                    `;
                } else {
                    let ph = type === 'emails' ? '信箱地址' : '網址';
                    let isValid = true;
                    if (item[valKey]) {
                        isValid = type === 'emails' ? Validator.isValidEmail(item[valKey]) : Validator.isValidURL(item[valKey]);
                    }
                    let errorClass = isValid ? 'border-slate-200 focus:ring-indigo-500' : 'border-red-400 focus:ring-red-500 text-red-600 bg-red-50/50';
                    let msgHidden = isValid ? 'hidden' : '';
                    inputsHTML = `<input type="text" value="${item[valKey] || ''}" placeholder="${ph}" oninput="updateListItem('${type}', ${idx}, '${valKey}', this.value, this)" class="flex-1 min-w-0 px-2.5 py-2 rounded-lg bg-white border ${errorClass} text-sm outline-none focus:ring-2 transition-all">`;
                    validationMsg = `<div class="validation-msg ${msgHidden} w-full text-[10px] text-red-500 font-bold ml-1 flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> 格式似乎有誤</div>`;
                }

                div.innerHTML = `
                    <div class="flex items-center gap-2 w-full">
                        <select onchange="updateListItem('${type}', ${idx}, 'type', this.value)" class="shrink-0 bg-slate-100 border border-slate-200 text-slate-600 text-[10px] rounded-lg px-1.5 py-2 outline-none">${optionsHTML}</select>
                        ${inputsHTML}
                        <button onclick="removeListItem('${type}', ${idx})" class="shrink-0 p-1 text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    ${validationMsg}
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        /**
         * [功能] 更新動態清單項目的值
         * - 會觸發對應的格式檢查 (如電話號碼正規化)
         * - 同步更新 `state.cardData` 並反映至 UI
         * - 觸發預覽更新
         * @param {string} listType - 清單類別 ('phones', 'faxes', 'emails', 'urls')
         * @param {number} idx - 在陣列中的索引位置
         * @param {string} key - 要更新的物件屬性鍵名 ('type', 'value', 'ext')
         * @param {string} val - 使用者輸入的新值
         * @param {HTMLElement} [el] - 觸發事件的輸入框元素 (用於即時驗證)
         * @returns {void}
         */
        window.updateListItem = (listType, idx, key, val, el) => {
            if (!state.cardData[listType][idx]) return;

            // 電話與傳真欄位的輸入檢核與濾除
            if (listType === 'phones' || listType === 'faxes') {
                if (key === 'value') {
                    // 只允許數字與常見電話符號：+, -, (, ), 空白
                    val = val.replace(/[^\d+\-() ]/g, '');
                } else if (key === 'ext') {
                    // 分機嚴格：只允許純數字
                    val = val.replace(/[^\d]/g, '');
                }
            }

            // 更新並格式化號碼
            state.cardData[listType][idx][key] = (key === 'value' && (listType === 'phones' || listType === 'faxes')) ? vCardFormatter.normalizePhone(val) : val;

            // 即時樣式驗證 (不重新渲染清單，避免失去焦點)
            if (el && (listType === 'emails' || listType === 'urls') && key === 'value') {
                let isValid = true;
                if (val) {
                    isValid = listType === 'emails' ? Validator.isValidEmail(val) : Validator.isValidURL(val);
                }
                const errorMsgEl = el.parentElement.parentElement.querySelector('.validation-msg');
                if (isValid) {
                    el.classList.remove('border-red-400', 'focus:ring-red-500', 'text-red-600', 'bg-red-50/50');
                    el.classList.add('border-slate-200', 'focus:ring-indigo-500');
                    if (errorMsgEl) errorMsgEl.classList.add('hidden');
                } else {
                    el.classList.remove('border-slate-200', 'focus:ring-indigo-500');
                    el.classList.add('border-red-400', 'focus:ring-red-500', 'text-red-600', 'bg-red-50/50');
                    if (errorMsgEl) errorMsgEl.classList.remove('hidden');
                }
            }

            // 同步回 UI 輸入框以反映過濾後的結果
            if ((listType === 'phones' || listType === 'faxes') && (key === 'value' || key === 'ext')) {
                const inputs = document.getElementById(`list-${listType}`).children[idx].querySelectorAll('input');
                if (key === 'value' && inputs[0]) inputs[0].value = state.cardData[listType][idx][key];
                if (key === 'ext' && inputs[1]) inputs[1].value = state.cardData[listType][idx][key];
            }

            debouncedUpdateVCardPreview();
        };

        /**
         * [功能] 新增一個空的動態清單項目
         * - 初始化預設值結構並加入 `state.cardData`
         * - 重新渲染該清單並更新預覽
         * @param {string} listType - 清單類別 ('phones', 'faxes', 'emails', 'urls')
         * @returns {void}
         */
        window.addListItem = (listType) => {
            const valKey = 'value';
            if (!state.cardData[listType]) state.cardData[listType] = [];
            let newItem = { type: 'work', [valKey]: "" };
            if (listType === 'phones' || listType === 'faxes') newItem.ext = "";
            state.cardData[listType].push(newItem);
            renderList(listType); debouncedUpdateVCardPreview();
        };

        /**
         * [功能] 移除指定的動態清單項目
         * @param {string} listType - 清單類別
         * @param {number} idx - 要移除的項目索引
         * @returns {void}
         */
        window.removeListItem = (listType, idx) => { state.cardData[listType].splice(idx, 1); renderList(listType); debouncedUpdateVCardPreview(); };

        /**
         * [UI 更新] 更新 vCard 預覽狀態
         * 包含產生 QR Code 與切換 Google Maps 按鈕顯示。
         * (為了避免快速輸入短時間內對 API 頻繁發送請求，所以外面會有 Debounce 包裝)
         * @returns {void}
         */
        function updateVCardPreview() {
            const d = state.cardData;
            const vcf = vCardFormatter.generate(d);
            state.vCardString = vcf;
            const hasContent = isValid(d.fn) || isValid(d.lastName) || isValid(d.orgName);
            const qrImage = document.getElementById('qrImage');

            if (hasContent) {
                try {
                    // QRious 需要我們先將 UTF-8 中文手動轉成正確的 Latin-1 / Byte 序列才不會變成亂碼
                    const utf8EncodedVcf = unescape(encodeURIComponent(vcf));

                    const qr = new QRious({
                        value: utf8EncodedVcf,
                        size: 600, // 給大一點的基礎大小以容納更多備註文字的細節度
                        level: 'L' // 稍微提高容錯或是降低，L=最低 M=中等 Q=高 H=極高
                    });

                    qrImage.src = qr.toDataURL();
                    qrImage.classList.remove('hidden'); document.getElementById('qrPlaceholder').classList.add('hidden');
                    document.getElementById('qrStatus').textContent = "掃描加入聯絡人";
                } catch (err) {
                    console.error('QR 產生錯誤:', err);
                    document.getElementById('qrStatus').textContent = "太多資料無法產生 QR Code";
                    qrImage.classList.add('hidden'); document.getElementById('qrPlaceholder').classList.remove('hidden');
                }
            } else {
                qrImage.classList.add('hidden'); document.getElementById('qrPlaceholder').classList.remove('hidden');
                document.getElementById('qrStatus').textContent = "等待資料輸入...";
            }
            // 若地址有任何內容，則顯示 Google Maps 按鈕
            document.getElementById('btn-maps').classList.toggle('hidden', ![d.country, d.region, d.locality, d.streetAddress].some(v => isValid(v)));

            // 若目前有載入歷史紀錄，自動儲存使用者的手動修改
            if (state.currentHistoryId) {
                DatabaseService.saveCard(state.cardData, state.base64Image, state.currentHistoryId)
                    .then(() => HistoryManager.render())
                    .catch(err => console.warn("自動寫入歷史紀錄失敗", err));
            }
        }

        const debouncedUpdateVCardPreview = debounce(updateVCardPreview, DEBOUNCE_DELAY_MS);

        /**
         * [功能] 下載 vCard 檔案 (.vcf)
         * 將記憶體中的 `state.vCardString` 直接轉檔下載
         * @returns {void}
         */
        function downloadVCard() {
            const filename = `${state.cardData.fn || 'contact'}.vcf`;
            ExportService.download(filename, state.vCardString);
            UXManager.toast("下載成功");
        }

        /**
         * [功能] 複製 vCard 文本內容至剪貼簿
         * @returns {void}
         */
        function copyVCardContent() {
            if (ExportService.copyToClipboard(state.vCardString)) {
                UXManager.toast("內容已複製");
            }
        }

        /**
         * [功能] 開啟 Google Maps 搜尋當前地址
         * @returns {void}
         */
        window.openGoogleMaps = () => {
            MapService.openGoogleMaps(state.cardData);
        };

        /**
         * [功能] 清空表單與影像狀態
         * - 恢復為 `DEFAULT_CARD_DATA`
         * - 重置圖片預覽、Debug 面板與草稿
         * @returns {void}
         */
        window.clearForm = () => {
            if (!confirm("確定要清空嗎？")) return;
            state.cardData = JSON.parse(JSON.stringify(DEFAULT_CARD_DATA));
            state.base64Image = null;
            state.currentHistoryId = null;
            document.getElementById('previewImage').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            resetEmailDraft(); syncDataToUI(); UXManager.toast("已清空資料");
        };

    </script>
</body>

</html>
